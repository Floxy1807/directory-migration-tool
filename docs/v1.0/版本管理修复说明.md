# 版本管理系统修复说明

## 问题描述

之前项目中的版本号管理存在以下问题：

1. **版本号写死在多个地方**
   - `.csproj` 文件中硬编码版本号（如 `1.0.6`）
   - `MainViewModel.cs` 从程序集读取版本号
   - 但程序集版本也是从 `.csproj` 写死的

2. **版本号不一致**
   - `version.json` 显示 `1.0.2`
   - `.csproj` 显示 `1.0.6`
   - GUI 显示的版本号取决于编译时的程序集版本

3. **手动维护困难**
   - 需要在多个地方同步修改版本号
   - 容易出现遗漏和不一致

## 解决方案

### 1. 统一版本号来源

创建 **单一版本号来源（Single Source of Truth）**：
- `version.json` 是唯一的版本号定义文件
- 所有其他地方的版本号都从这里动态获取或同步

### 2. 实现的组件

#### VersionService.cs
```
MoveWithSymlinkWPF/Services/VersionService.cs
```

**功能**：
- 运行时动态读取 `version.json`
- 如果找不到，回退到程序集版本
- 缓存版本号以提高性能

**查找逻辑**：
1. 应用程序目录的 `version.json`（发布后）
2. 项目根目录的 `version.json`（开发时）
3. 程序集版本信息（最后回退）

#### MainViewModel.cs 更新
```csharp
// 之前：从程序集读取
var assembly = Assembly.GetExecutingAssembly();
var assemblyVersion = assembly.GetName().Version;
VersionText = $"v{assemblyVersion.Major}.{assemblyVersion.Minor}.{assemblyVersion.Build}";

// 现在：使用 VersionService
VersionText = VersionService.GetVersion();
```

#### .csproj 文件配置
```xml
<!-- 包含 version.json 到发布输出 -->
<ItemGroup>
  <None Include="..\version.json">
    <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    <Link>version.json</Link>
    <CopyToPublishDirectory>PreserveNewest</CopyToPublishDirectory>
  </None>
</ItemGroup>
```

#### 版本同步脚本

**sync-version.ps1** - 手动同步脚本
```powershell
.\sync-version.ps1
```
- 从 `version.json` 读取版本号
- 更新 `.csproj` 中的 `<Version>`, `<AssemblyVersion>`, `<FileVersion>`
- 使用 UTF-8 编码避免中文乱码

**publish.ps1 改进** - 发布时自动同步
```powershell
.\publish.ps1                      # 递增版本并发布
.\publish.ps1 -SkipVersionIncrement # 不递增，只同步并发布
```

### 3. 编码问题修复

**问题**：
```
Error: Invalid character in the given encoding. Line 17, position 34.
```

**原因**：
- PowerShell 默认使用系统编码
- 在读写包含中文的文件时可能损坏字符
- 导致"符号链接"变成"符号链�?"

**解决方案**：
所有脚本中的文件读写都明确指定 UTF-8 编码：
```powershell
Get-Content $file -Encoding UTF8 -Raw
Set-Content $file -Encoding UTF8 -NoNewline
```

## 工作流程

### 日常开发
1. 修改代码
2. 运行 `.\publish.ps1` 发布
3. 脚本自动递增版本号并同步

### 手动版本管理
1. 编辑 `version.json`
2. 运行 `.\sync-version.ps1`
3. 运行 `.\publish.ps1 -SkipVersionIncrement`

### GUI 版本显示
- 运行时自动从 `version.json` 读取
- 显示在窗口标题、右上角和底部状态栏
- 无需重新编译即可更新版本号显示

## 测试验证

### 1. 版本同步测试
```powershell
# 查看当前版本
Get-Content version.json

# 同步到 .csproj
.\sync-version.ps1

# 验证 .csproj 已更新
Select-String -Path "MoveWithSymlinkWPF\MoveWithSymlinkWPF.csproj" -Pattern "<Version>"
```

### 2. 发布测试
```powershell
# 发布并验证版本号
.\publish.ps1 -SkipVersionIncrement

# 检查生成的文件名
Get-ChildItem "MoveWithSymlinkWPF\bin\publish\win-x64\*.exe"
```

### 3. GUI 显示测试
1. 运行应用程序
2. 检查右上角版本号显示
3. 检查底部状态栏版本号

## 文件清单

### 新增文件
- `MoveWithSymlinkWPF/Services/VersionService.cs` - 版本管理服务
- `sync-version.ps1` - 版本同步脚本
- `docs/版本管理说明-更新.md` - 完整版本管理文档
- `docs/版本管理修复说明.md` - 本文档

### 修改文件
- `MoveWithSymlinkWPF/ViewModels/MainViewModel.cs` - 使用 VersionService
- `MoveWithSymlinkWPF/MoveWithSymlinkWPF.csproj` - 包含 version.json，版本号已同步
- `publish.ps1` - 改进编码处理，确保总是同步版本号

## 最佳实践

✅ **正确做法**：
1. 只修改 `version.json`
2. 运行 `sync-version.ps1` 同步
3. 使用 `publish.ps1` 发布
4. 提交代码时确保版本号已同步

❌ **错误做法**：
1. 直接修改 `.csproj` 中的版本号
2. 在代码中硬编码版本号
3. 手动修改程序集版本
4. 不使用 UTF-8 编码处理文件

## 故障排除

### 问题：版本号显示错误
**检查**：
```powershell
# 1. 确认 version.json 存在且格式正确
Get-Content version.json

# 2. 确认 .csproj 已同步
.\sync-version.ps1

# 3. 重新发布
.\publish.ps1 -SkipVersionIncrement
```

### 问题：编码错误
**症状**：中文字符变成乱码（如 "链�?"）

**解决**：
1. 确保所有源文件使用 UTF-8 编码保存
2. 使用更新后的脚本（已包含 `-Encoding UTF8`）
3. 重新运行 `sync-version.ps1`

### 问题：发布文件不包含 version.json
**检查**：
```powershell
# 查看发布目录
Get-ChildItem "MoveWithSymlinkWPF\bin\publish\win-x64\"

# 应该包含 version.json 文件
```

**修复**：确认 `.csproj` 包含正确的配置（已在修复中添加）

## 总结

现在项目的版本管理系统：
- ✅ 统一的版本号来源（version.json）
- ✅ 自动同步机制
- ✅ GUI 动态显示版本号
- ✅ UTF-8 编码支持
- ✅ 完整的文档和脚本

版本号现在可以：
1. 在 GUI 中动态显示
2. 自动同步到项目文件
3. 包含在发布的可执行文件名中
4. 通过简单的脚本管理

