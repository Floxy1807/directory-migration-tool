# v1.1 一键迁移功能 - 实现说明

更新时间：2025-10-28  
实现者：Claude (AI Assistant)

## 概述

v1.1 版本在现有手动迁移功能的基础上，新增了"一键迁移模式"，实现了基于配置文件的自动批量迁移、迁移状态管理、以及完整的还原功能。

## 主要功能

### 1. 一键迁移模式
- 通过 `quick-migrate.json` 配置文件定义多个待迁移目录
- 支持软件 Profile（通过注册表定位）和独立源目录两种方式
- 自动扫描有效任务并分组显示
- 顺序执行迁移，单项失败不阻塞后续项

### 2. 迁移状态管理
- **未迁移** Tab：显示所有待迁移的任务
- **已迁移** Tab：显示所有已完成迁移的任务
- 自动检测迁移状态（基于符号链接和标记文件）
- 支持中断恢复和异常状态识别

### 3. 还原功能
- 完整的反向迁移流程
- 支持保留或删除目标数据（可配置）
- 6 阶段进度与正向迁移保持一致
- 自动删除符号链接并恢复原始目录结构

### 4. 中断与恢复
- 使用标记文件记录迁移/还原状态
- 支持复制中断后的续传（robocopy /Z /ZB）
- 自动识别未完成任务并提供恢复选项

## 新增文件

### MigrationCore（核心服务层）

#### Models
- **QuickMigrateConfig.cs**: 配置模型
  - `QuickMigrateConfig`: 主配置类
  - `QuickMigrateDefaults`: 默认配置参数
  - `QuickMigrateProfile`: 软件 Profile 定义
  - `QuickMigrateLocator`: 注册表定位器配置
  - `QuickMigrateStandaloneSource`: 独立源目录配置

- **QuickMigrateTask.cs**: 任务模型
  - `QuickMigrateTask`: 迁移任务
  - `QuickMigrateTaskStatus`: 任务状态枚举
  - `MigrationState`: 迁移状态枚举
  - `MigrationMode`: 迁移模式枚举（Migrate/Restore）

#### Services
- **QuickMigrateConfigLoader.cs**: 配置加载器
  - `LoadConfig()`: 加载配置文件
  - `SaveConfig()`: 保存配置文件
  - `CreateExampleConfig()`: 创建示例配置

- **RegistryLocatorService.cs**: 注册表定位服务
  - `LocateInstallRoot()`: 通过注册表定位安装根目录
  - `ExpandProfileToTasks()`: 展开 Profile 到任务列表
  - `ExpandStandaloneSourceToTasks()`: 展开独立源到任务列表
  - `DeduplicateTasks()`: 任务去重

- **MigrationStateDetector.cs**: 状态检测服务
  - `DetectMigrationState()`: 检测任务的迁移状态
  - `FindBackupPath()`: 查找备份路径
  - `CreateMigrateLockFile()`: 创建迁移锁文件
  - `CreateMigrateDoneFile()`: 创建迁移完成标记
  - `CreateRestoreLockFile()`: 创建还原锁文件
  - `CreateRestoreDoneFile()`: 创建还原完成标记
  - `DeleteMigrateMarkers()`: 删除迁移标记
  - `DeleteRestoreMarkers()`: 删除还原标记

- **ReversibleMigrationService.cs**: 可逆迁移服务
  - 支持 Migrate 和 Restore 两种模式
  - 完整的 6 阶段进度报告
  - 自动回滚机制
  - 增强的 robocopy 参数（/Z /ZB 支持续传）

### MoveWithSymlinkWPF（UI 层）

#### Views
- **QuickMigratePage.xaml**: 一键迁移页面 UI
  - 顶部操作区（目标策略、刷新、开始迁移）
  - Tab 切换（未迁移/已迁移）
  - 任务卡片列表（分组显示）
  - 底部日志区域

- **QuickMigratePage.xaml.cs**: 页面代码隐藏

#### ViewModels
- **QuickMigrateViewModel.cs**: 一键迁移页面 ViewModel
  - 配置加载和任务扫描
  - 目标目录策略管理
  - 批量迁移执行
  - 单任务还原
  - 备份清理

#### Converters（扩展）
- **BoolToColorConverter**: 模式按钮背景色转换器
- **BoolToForegroundConverter**: 模式按钮前景色转换器

#### 主窗口修改
- **MainWindow.xaml**: 添加模式切换按钮
- **MainViewModel.cs**: 添加模式切换逻辑

### 配置文件
- **quick-migrate.json**: 一键迁移配置文件示例

## 配置文件结构

```json
{
  "defaults": {
    "largeFileThresholdMB": 1024,
    "robocopyThreads": 8,
    "targetStrategy": "unified",        // 或 "perTask"
    "unifiedTargetRoot": "E:\\Migrated",
    "restoreKeepTarget": false          // 还原时是否保留目标数据
  },
  "profiles": [
    {
      "id": "AppId",
      "name": "应用名称",
      "locator": {
        "type": "registryDisplayIcon",
        "hive": "HKCU",                 // 或 "HKLM"
        "keyPath": "Software\\...",
        "valueName": "DisplayIcon"
      },
      "items": [
        {
          "displayName": "项目",
          "relativePath": "Projects",
          "enabled": true
        }
      ]
    }
  ],
  "standaloneSources": [
    {
      "displayName": "自定义目录",
      "absolutePath": "D:\\MyData",
      "enabled": true
    }
  ]
}
```

## 标记文件

### 迁移标记
- **.xinghe-migrate.lock**: 迁移开始时创建，包含源路径和启动时间
- **.xinghe-migrate.done**: 复制完成后创建，表示数据已完整复制

### 还原标记
- **.xinghe-reduction.lock**: 还原开始时创建
- **.xinghe-reduction.done**: 还原完成后创建

### 作用
- 用于检测中断状态
- 支持复制未完成的识别
- 辅助状态判定（主要依据仍是文件系统状态）

## 状态检测逻辑

### MigrationState 枚举值

1. **Pending（待迁移）**
   - 源是普通目录
   - 未创建符号链接

2. **Migrated（已迁移）**
   - 源是符号链接
   - 目标存在且可访问

3. **Inconsistent（不一致）**
   - 源是符号链接
   - 但目标不存在或不可访问

4. **NeedsCleanup（待清理）**
   - 已迁移
   - 但存在备份目录（*.bak_*）

5. **NeedsCompletion（待完成）**
   - 源已备份或不存在
   - 目标数据存在
   - 但符号链接未创建

## 执行流程

### 迁移流程（6 阶段）
1. **路径解析与验证**
   - 验证源路径和目标路径
   - 创建目标目录
   - 创建迁移锁文件

2. **扫描源目录**
   - 统计文件数和大小
   - 检查磁盘空间

3. **复制文件**
   - 使用 robocopy /MIR /Z /ZB
   - 实时进度报告（10%-90%）
   - 创建迁移完成标记

4. **创建符号链接**
   - 备份源目录（*.bak_timestamp）
   - 创建符号链接

5. **健康检查**
   - 验证符号链接
   - 验证可访问性

6. **清理备份**
   - 删除备份目录

### 还原流程（6 阶段）
1. **路径解析与验证**
   - 验证源是符号链接
   - 验证目标存在
   - 检查源磁盘空间
   - 创建还原锁文件

2. **扫描数据目录**
   - 扫描目标路径（实际数据位置）

3. **还原文件**
   - 复制：目标 → 临时目录
   - 使用 robocopy /MIR /Z /ZB
   - 创建还原完成标记

4. **解除符号链接**
   - 删除符号链接
   - 移动临时目录到源位置

5. **健康检查**
   - 验证源目录恢复
   - 验证不再是符号链接

6. **清理收尾**
   - 根据配置决定是否删除目标数据
   - 清理还原标记

## UI 交互

### 顶部操作区
- **统一目标目录**: 勾选框 + 文本框 + 浏览按钮
- **刷新扫描**: 重新加载配置并扫描
- **开始一键迁移**: 批量执行所有未迁移任务
- **取消**: 取消当前执行

### 未迁移 Tab
- 按 ProfileName 分组
- 每个任务显示：
  - 显示名称
  - 源路径和目标路径
  - 实时进度（执行时）
  - 状态消息

### 已迁移 Tab
- 按 ProfileName 分组
- 每个任务显示：
  - 显示名称
  - 符号链接路径和实际目标
  - 迁移时间
  - 操作按钮：还原、清理备份

### 日志区域
- 时间戳日志
- 显示成功/失败计数
- 实时滚动

## 错误处理

### 注册表定位失败
- 该 Profile 不显示任何任务
- 不影响其他 Profile 和独立源

### 源目录不存在
- 跳过该任务
- 不纳入任务列表

### 复制失败（退出码 ≥ 8）
- 标记任务为失败
- 尝试回滚
- 继续执行后续任务

### 符号链接创建失败
- 尝试 P/Invoke 方法
- 失败后尝试 cmd mklink
- 仍失败则回滚并标记失败

### 还原失败
- 尝试回滚
- 保持原有符号链接状态

## 兼容性

### 权限
- 非管理员模式：提示启用开发者模式
- 符号链接创建使用 SYMBOLIC_LINK_FLAG_ALLOW_UNPRIVILEGED_CREATE

### 注册表
- 支持 HKCU 和 HKLM
- 自动处理 x64/x86 视图

### Robocopy 参数
- `/Z`: 可续传模式（支持大文件中断恢复）
- `/ZB`: 无法普通读取时回退到备份模式
- `/MIR`: 镜像模式
- `/COPYALL`: 复制所有文件信息
- `/DCOPY:DAT`: 复制目录时间戳
- `/R:0 /W:0`: 不重试
- `/XJ`: 排除连接点
- `/NFL /NDL /NP`: 减少日志输出
- `/MT:n`: 多线程复制

## 与手动模式的关系

### 共存
- 两种模式完全独立
- 可通过顶部按钮切换
- 手动模式保持原有功能不变

### 复用
- 共享 `MigrationConfig`、`MigrationProgress`、`MigrationResult` 等核心模型
- 共享 `FileStatsService`、`PathValidator`、`SymbolicLinkHelper` 等工具服务
- 一键迁移使用 `ReversibleMigrationService`，手动模式使用 `MigrationService`

## 测试建议

### 基础测试
1. 无配置文件：显示"未找到配置文件"
2. 配置文件格式错误：显示"未找到配置文件"
3. 所有源目录不存在：显示"无可一键迁移目录"
4. 部分源存在：只显示存在的任务

### 功能测试
1. 统一目标模式：验证自动拼接源目录名
2. 分任务目录模式：每行可单独设置目标
3. 顺序执行：验证按列表顺序执行
4. 单项失败：验证不影响后续项

### 状态测试
1. 正常迁移：未迁移 → 已迁移
2. 复制中断：检测到可恢复状态
3. 创建链接中断：检测到待完成状态
4. 还原成功：已迁移 → 未迁移

### 边界测试
1. 磁盘空间不足：阻止迁移
2. 目标非空：自动拼接源目录名
3. 符号链接目标缺失：显示为不一致状态
4. 存在备份：显示待清理状态

## 未来扩展

### 配置文件
- 支持更多定位器类型（StartMenu LNK、App Paths）
- 支持自定义 robocopy 参数
- 支持排除规则

### 执行策略
- 并行执行模式
- 优先级排序
- 定时任务

### UI 增强
- 任务编辑功能
- 配置文件可视化编辑
- 迁移历史记录

### 高级功能
- 增量同步模式
- 迁移日志持久化
- 批量还原

## 已知限制

1. 配置文件需手动编写（不提供 GUI 编辑）
2. 仅支持顺序执行（不支持并行）
3. 注册表定位仅支持 DisplayIcon 类型
4. 不支持网络路径
5. 标记文件可能被用户手动删除（但不影响核心功能）

## 总结

v1.1 版本成功实现了一键迁移模式的所有核心功能，包括：
- ✅ 配置文件加载和解析
- ✅ 注册表定位和任务展开
- ✅ 迁移状态检测和分类
- ✅ 批量迁移执行
- ✅ 完整的还原功能
- ✅ 中断恢复支持
- ✅ 标记文件管理
- ✅ UI 双模式切换
- ✅ 完整的错误处理和回滚

该版本在保持现有手动模式功能完整性的同时，为批量迁移场景提供了便捷的自动化方案。


