# 版本管理说明

## 概述

本项目使用 `version.json` 作为单一版本号来源（Single Source of Truth），所有地方的版本号都从这个文件动态获取。

## 版本号来源

### 主版本文件：version.json

```json
{
  "major": 1,
  "minor": 0,
  "patch": 2,
  "description": "版本号管理文件 - 每次打包时自动递增 patch 版本号"
}
```

**重要规则**：
- ✅ **只修改 `version.json`** - 这是唯一需要手动编辑版本号的文件
- ❌ **不要直接修改 `.csproj` 文件中的版本号** - 它会被自动同步

## 版本号使用场景

### 1. GUI 界面显示

程序运行时，GUI 会动态读取版本号并显示：
- 窗口标题栏中显示产品名称
- 右上角显示版本号（如 `v1.0.2`）
- 底部状态栏显示完整版本信息

**实现方式**：
- `MoveWithSymlinkWPF/Services/VersionService.cs` - 版本服务类
- `MoveWithSymlinkWPF/ViewModels/MainViewModel.cs` - 在 ViewModel 中调用版本服务

**查找顺序**：
1. 首先尝试从应用程序目录读取 `version.json`
2. 如果找不到，尝试从项目根目录读取（开发模式）
3. 最后回退到程序集版本信息

### 2. 发布的可执行文件

发布时，可执行文件的名称会包含版本号：
- 自包含版本：`目录迁移工具-v1.0.2.exe`
- 框架依赖版本：`目录迁移工具-v1.0.2-lite.exe`

### 3. 程序集版本信息

`.csproj` 文件中的版本号会在发布前自动同步：
```xml
<Version>1.0.2</Version>
<AssemblyVersion>1.0.2.0</AssemblyVersion>
<FileVersion>1.0.2.0</FileVersion>
```

## 版本同步机制

### 自动同步（推荐）

使用发布脚本时会自动同步版本号：

```powershell
# 发布并自动递增 patch 版本号
.\publish.ps1

# 发布但不递增版本号（只同步现有版本）
.\publish.ps1 -SkipVersionIncrement
```

### 手动同步

如果需要在不发布的情况下同步版本号到 `.csproj`：

```powershell
.\sync-version.ps1
```

**使用场景**：
- 手动修改了 `version.json` 后
- 需要在本地调试时使用正确的版本号
- Git 切换分支后版本号不一致时

## 版本号递增规则

### 自动递增（发布时）

运行 `.\publish.ps1` 时会自动递增 `patch` 版本号：
- 1.0.2 → 1.0.3
- 1.0.9 → 1.0.10
- 等等

### 手动调整

修改 `version.json` 来手动设置版本号：

**小版本更新（新功能）**：
```json
{
  "major": 1,
  "minor": 1,  // 从 0 增加到 1
  "patch": 0   // 重置为 0
}
```

**大版本更新（重大变更）**：
```json
{
  "major": 2,  // 从 1 增加到 2
  "minor": 0,  // 重置为 0
  "patch": 0   // 重置为 0
}
```

修改后运行 `.\sync-version.ps1` 同步到项目文件。

## 文件包含配置

`version.json` 会在发布时自动包含到输出目录中：

```xml
<!-- MoveWithSymlinkWPF.csproj -->
<ItemGroup>
  <None Include="..\version.json">
    <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    <Link>version.json</Link>
    <CopyToPublishDirectory>PreserveNewest</CopyToPublishDirectory>
  </None>
</ItemGroup>
```

## 工作流程

### 日常开发流程

1. 修改代码
2. 本地测试
3. 准备发布时运行 `.\publish.ps1`
4. 脚本会自动：
   - 递增 patch 版本号
   - 更新 version.json
   - 同步版本号到 .csproj
   - 编译发布程序
   - 生成带版本号的可执行文件

### 手动版本管理流程

1. 编辑 `version.json` 设置新版本号
2. 运行 `.\sync-version.ps1` 同步版本号
3. 运行 `.\publish.ps1 -SkipVersionIncrement` 发布（不再递增）

## 脚本说明

### sync-version.ps1

**功能**：从 `version.json` 同步版本号到 `.csproj` 文件

**用法**：
```powershell
.\sync-version.ps1
```

### publish.ps1

**功能**：发布应用程序，支持自动版本管理

**参数**：
- `-Mode <all|selfcontained|lite|both>` - 发布模式
  - `selfcontained`（默认）：自包含版本
  - `lite`：框架依赖版本
  - `both` 或 `all`：同时发布两个版本
  
- `-SkipVersionIncrement` - 跳过版本号递增

**示例**：
```powershell
# 发布自包含版本并递增版本号
.\publish.ps1

# 发布轻量级版本但不递增版本号
.\publish.ps1 -Mode lite -SkipVersionIncrement

# 同时发布两个版本并递增版本号
.\publish.ps1 -Mode both
```

## 最佳实践

1. ✅ **始终通过 version.json 管理版本号**
2. ✅ **使用 publish.ps1 自动递增版本号**
3. ✅ **提交代码前确保 version.json 和 .csproj 已同步**
4. ❌ **不要手动编辑 .csproj 中的版本号**
5. ❌ **不要在代码中硬编码版本号**

## 故障排除

### 问题：GUI 显示的版本号不正确

**原因**：version.json 未被包含到发布输出中

**解决方案**：
1. 检查 `.csproj` 中是否包含 version.json 的配置
2. 重新发布应用程序

### 问题：.csproj 版本号与 version.json 不一致

**原因**：手动修改了 version.json 但未同步

**解决方案**：
```powershell
.\sync-version.ps1
```

### 问题：发布时版本号未递增

**原因**：使用了 `-SkipVersionIncrement` 参数

**解决方案**：
```powershell
# 不带参数运行
.\publish.ps1
```

### 问题：PowerShell 编码错误

**原因**：version.json 文件编码问题

**解决方案**：
- 确保 version.json 使用 UTF-8 编码保存
- 脚本已配置为使用 UTF-8 编码读取

## 版本历史

查看项目的版本历史，请参考：
- `version.json` - 当前版本
- `docs/CHANGELOG.md` - 详细的版本变更记录
- Git 提交历史 - 每次版本更新的提交

