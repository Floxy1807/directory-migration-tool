# 目录迁移工具（mklink /D）需求说明

### 1. 目标与范围
- **目标**：将体积较大的目录从 `C:` 等系统盘迁移到其他磁盘/路径，并在原路径创建目录符号链接（`mklink /D`），对应用和系统透明。
- **范围**：用户自行选择任意非关键系统目录（用户数据、游戏、下载、工程构建缓存等）。默认不支持迁移关键系统目录（如 `C:\Windows`、`C:\Program Files` 等）。

### 2. 实现选型
- **链接类型**：统一使用目录符号链接 `mklink /D`（支持跨盘、可指向网络路径）。
- **复制方式**：使用 `robocopy` 镜像复制，保留 ACL/时间戳/ADS（`/MIR /COPYALL /DCOPY:DAT`），支持多线程 `/MT` 与断点续传特性。
- **平台与发布**：Windows 10/11，NTFS 目标推荐。首版以 PowerShell CLI 形式交付，后续可升级为 C# GUI。

### 3. 功能需求
1) **选择与分析**
   - 用户手动指定源目录与目标目录。
   - 预扫描源目录：统计总大小、文件数、以及“超过阈值的大文件个数”（阈值默认 1GB，可配置）。
2) **迁移执行（事务化）**
   - 预检查：存在性、权限提示、剩余空间（提示）、路径冲突与相对关系检查（目标不可位于源内、二者不可相同）。
   - 复制：调用 `robocopy` 按镜像方式复制；可配置并行线程数与进度刷新间隔。
   - 切换：将源目录重命名为 `.bak_时间戳`，在原位置创建 `mklink /D` 指向目标。
   - 健康检查：验证新建对象为重解析点（符号链接）且可访问。
   - 清理：验证通过后删除 `.bak`；失败自动回滚（删除链接、还原 `.bak`）。
3) **可观测性**
   - 实时进度条（百分比、已复制/总大小、吞吐、ETA）；
   - 迁移前显示大文件（≥阈值）个数；
   - 分步日志与错误提示（包含出错行与调用片段，便于定位）。
4) **安全与回滚**
   - 核心步骤原子化（复制→验证→切换→清理）。
   - 任一步失败均回滚至可用状态。
5) **可扩展（未来）**
   - 批量计划、过滤规则（忽略缓存/临时文件）、哈希校验模式（可选全量/抽样）。

### 4. 非功能需求
- **可靠性**：失败不影响原路径可用；中断具恢复策略。
- **性能**：多线程复制、显示吞吐与 ETA；可调并发与刷新周期。
- **易用性**：命令行一步完成；错误信息清晰。
- **兼容性**：Windows 10/11；目标推荐 NTFS；符号链接可指向网络路径（需注意权限）。
- **日志**：控制台实时输出，后续可扩展到文件日志（结构化）。

### 5. 权限与兼容性说明
- 建议以管理员运行；若非管理员则需启用“开发者模式”以允许创建符号链接。
- 建议目标为 NTFS 分区；网络路径也可（符号链接支持）。
- 建议启用长路径支持以避免极端路径问题。

### 6. 默认阻止/警告目录
- **阻止**：`C:\Windows`、`C:\Program Files`、`C:\Program Files (x86)`、`C:\ProgramData` 的核心子目录，`C:\Users\\<User>\\AppData` 下的系统关键子树等。
- **警告**：`AppData` 下非关键缓存（按白名单放行）与云盘同步目录（OneDrive/Dropbox）可能导致冲突。

### 7. 交付物（当前版本：PowerShell CLI）
- 脚本文件：`MoveWithSymlink.ps1`
- 核心参数：
  - `-Source`：源目录（必填）
  - `-Target`：目标目录（必填）
  - `-LargeFileThresholdMB`：大文件阈值（默认 1024=1GB）
  - `-RobocopyThreads`：复制并行线程数（默认 8）
  - `-SampleMilliseconds`：进度采样间隔毫秒（默认 1000ms）

### 8. 使用示例
```powershell
cd C:\ProjectDev\project\moveFloder
.\u005cMoveWithSymlink.ps1 -Source "C:\Users\<UserName>\Pictures\testMove" -Target "D:\Data\testMove" -LargeFileThresholdMB 1024 -RobocopyThreads 8 -SampleMilliseconds 1000
```

### 9. 迁移流程（脚本内部）
1) 解析并校验路径，创建目标父目录/目标目录（若不存在）。
2) 扫描源目录，统计总大小、文件数与大文件个数。
3) 调用 `robocopy` 进行镜像复制；前台轮询目标体量，显示进度/速度/ETA。
4) 将源目录改名为 `.bak_时间戳`，执行 `mklink /D "源" "目标"`；验证符号链接创建成功。
5) 成功则删除 `.bak` 并输出总结；失败则删除链接并还原 `.bak`。

### 10. 验收标准（示例）
- 选取 ≥5GB 的目录进行迁移，完成后：
  - 原路径可访问（符号链接有效），读写正常；
  - 目标目录大小与文件数符合预期（允许少量索引差异）；
  - 控制台打印大文件个数、总大小、总文件数与过程进度；
  - 失败时能自动回滚，原路径保持可用。

### 11. 未来增强方向
- GUI（WinUI 3/WPF）向导式界面、批量计划、空闲时执行；
- 更细的健康检查与哈希校验；
- 云盘集成提示、暂停同步选项；
- 结构化文件日志与报告导出（JSON/CSV）。

# C# 正式实现建议
框架：.NET 8 + WinUI 3/WPF（GUI）+ 同步的 CLI 项目，共用核心库。
复制：调用 robocopy 或使用 CopyFileEx/IFileOperation（更可控）。
链接：直接用 mklink（最简单）或 P/Invoke CreateSymbolicLink（可避免依赖 cmd）。
权限：UAC 提升、检测开发者模式；详尽日志（Serilog）、回滚机制、校验（大小/哈希）。
UI：向导式步骤（选择源/目标→预检查→迁移→结果），带进度与日志输出。

——

本说明对应的脚本实现位于 `MoveWithSymlink.ps1`，已包含进度条（百分比、吞吐、ETA）与大文件计数能力。


