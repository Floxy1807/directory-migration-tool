# 系统架构图

## 总体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户界面层 (UI Layer)                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────┐         ┌──────────────────────┐    │
│  │  PowerShell CLI      │         │   WinUI 3 GUI        │    │
│  │  MoveWithSymlink.ps1 │         │ MoveWithSymlinkGUI   │    │
│  └──────────────────────┘         └──────────────────────┘    │
│            │                                 │                  │
│            │                                 │                  │
│            │         ┌───────────────────────┘                  │
│            │         │                                          │
└────────────┼─────────┼──────────────────────────────────────────┘
             │         │
             ▼         ▼
┌─────────────────────────────────────────────────────────────────┐
│                      业务逻辑层 (Business Layer)                  │
├─────────────────────────────────────────────────────────────────┤
│                        MigrationCore Library                     │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │                    Models (数据模型)                      │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │    │
│  │  │ Migration    │  │  File        │  │ Migration    │  │    │
│  │  │ Config       │  │  Stats       │  │ Progress     │  │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  │    │
│  │         ┌──────────────┐                                │    │
│  │         │ Migration    │                                │    │
│  │         │ Result       │                                │    │
│  │         └──────────────┘                                │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │                   Services (服务层)                       │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │    │
│  │  │ Migration    │  │  Path        │  │ FileStats    │  │    │
│  │  │ Service      │  │  Validator   │  │ Service      │  │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  │    │
│  │         ┌──────────────┐                                │    │
│  │         │ Symbolic     │                                │    │
│  │         │ LinkHelper   │                                │    │
│  │         └──────────────┘                                │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                  │
└──────────────────────────┬───────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                      系统调用层 (System Layer)                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  Robocopy    │  │  P/Invoke    │  │   File       │         │
│  │  (复制文件)   │  │ CreateSymlink│  │   System     │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐                            │
│  │   cmd.exe    │  │   Windows    │                            │
│  │   mklink     │  │   API        │                            │
│  └──────────────┘  └──────────────┘                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## GUI 应用架构（MVVM）

```
┌─────────────────────────────────────────────────────────────────┐
│                          View (视图层)                            │
├─────────────────────────────────────────────────────────────────┤
│                         MainWindow.xaml                          │
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │   步骤 1      │  │   步骤 2      │  │   步骤 3      │         │
│  │  选择路径     │  │  扫描分析     │  │  执行迁移     │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│         ┌──────────────┐                                        │
│         │   步骤 4      │                                        │
│         │    完成       │                                        │
│         └──────────────┘                                        │
│                                                                  │
└───────────────────────────┬──────────────────────────────────────┘
                            │ Data Binding (数据绑定)
                            │ Command Binding (命令绑定)
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                      ViewModel (视图模型层)                       │
├─────────────────────────────────────────────────────────────────┤
│                        MainViewModel.cs                          │
│                                                                  │
│  【属性 (Properties)】                                            │
│  • SourcePath, TargetPath                                       │
│  • CurrentStep, ProgressPercent                                 │
│  • LogMessages, StatsMessage                                    │
│  • IsValidating, IsScanning, IsMigrating                        │
│                                                                  │
│  【命令 (Commands)】                                              │
│  • BrowseSourceCommand, BrowseTargetCommand                     │
│  • ValidateAndProceedCommand                                    │
│  • ScanAndProceedCommand                                        │
│  • StartMigrationCommand, CancelMigrationCommand                │
│  • BackToStep1Command, BackToStep2Command, ResetCommand        │
│                                                                  │
└───────────────────────────┬──────────────────────────────────────┘
                            │ 调用服务
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Model (模型层 / 服务层)                      │
├─────────────────────────────────────────────────────────────────┤
│                       MigrationCore Library                      │
│                                                                  │
│  • MigrationService.ExecuteMigrationAsync()                     │
│  • PathValidator.ValidateSourcePath()                           │
│  • FileStatsService.ScanDirectoryAsync()                        │
│  • SymbolicLinkHelper.CreateDirectorySymbolicLink()             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 迁移流程图

```
                        ┌─────────────┐
                        │   开始      │
                        └──────┬──────┘
                               │
                        ┌──────▼──────┐
                        │ [阶段 1/6]  │
                        │ 路径解析验证 │
                        └──────┬──────┘
                               │
                    ┌──────────▼──────────┐
                    │ 检查源路径是否存在？  │
                    └──────┬──────┬───────┘
                           │ 是   │ 否
                           │      └─────────────┐
                    ┌──────▼──────┐            │
                    │ 验证目标路径 │            │
                    └──────┬──────┘            │
                           │                   │
                    ┌──────▼──────┐            │
                    │ 检查路径关系 │            │
                    └──────┬──────┘            │
                           │                   │
                    ┌──────▼──────┐            │
                    │ 检查权限/空间│            │
                    └──────┬──────┘            │
                           │                   │
                        ┌──▼──────┐            │
                        │ [阶段 2] │            │
                        │ 扫描源目录│            │
                        └──┬───────┘            │
                           │                   │
                    ┌──────▼──────┐            │
                    │ 统计文件数量 │            │
                    └──────┬──────┘            │
                           │                   │
                    ┌──────▼──────┐            │
                    │ 统计总大小   │            │
                    └──────┬──────┘            │
                           │                   │
                    ┌──────▼──────┐            │
                    │ 统计大文件数 │            │
                    └──────┬──────┘            │
                           │                   │
                        ┌──▼──────┐            │
                        │ [阶段 3] │            │
                        │ 复制文件  │            │
                        └──┬───────┘            │
                           │                   │
                    ┌──────▼──────┐            │
                    │启动 robocopy │            │
                    └──────┬──────┘            │
                           │                   │
                    ┌──────▼──────┐            │
                    │监控复制进度  │            │
                    └──────┬──────┘            │
                           │                   │
                    ┌──────▼──────┐            │
                    │验证复制完整性│            │
                    └──────┬──────┘            │
                           │                   │
                        ┌──▼──────┐            │
                        │ [阶段 4] │            │
                        │创建符号链接│           │
                        └──┬───────┘            │
                           │                   │
                    ┌──────▼──────┐            │
                    │备份源目录    │            │
                    └──────┬──────┘            │
                           │                   │
                    ┌──────▼──────┐            │
                    │创建 mklink   │            │
                    └──────┬──────┘            │
                           │                   │
                        ┌──▼──────┐            │
                        │ [阶段 5] │            │
                        │ 健康检查  │            │
                        └──┬───────┘            │
                           │                   │
                    ┌──────▼──────┐            │
                    │验证重解析点  │            │
                    └──────┬──────┘            │
                           │                   │
                    ┌──────▼──────┐            │
                    │测试链接访问  │            │
                    └──────┬──────┘            │
                           │                   │
                        ┌──▼──────┐            │
                        │ [阶段 6] │            │
                        │ 清理备份  │            │
                        └──┬───────┘            │
                           │                   │
                    ┌──────▼──────┐            │
                    │删除备份目录  │            │
                    └──────┬──────┘            │
                           │                   │
                        ┌──▼──────┐            │
                        │ 成功完成 │            │
                        └──────────┘            │
                                                │
                                         ┌──────▼──────┐
                                         │ 失败 - 回滚 │
                                         └──────┬──────┘
                                                │
                                         ┌──────▼──────┐
                                         │ 删除链接    │
                                         └──────┬──────┘
                                                │
                                         ┌──────▼──────┐
                                         │ 还原备份    │
                                         └──────┬──────┘
                                                │
                                         ┌──────▼──────┐
                                         │ 回滚完成    │
                                         └─────────────┘
```

---

## 数据流图

```
用户操作
    │
    ├─→ [选择源目录] ──→ SourcePath (属性)
    │
    ├─→ [选择目标目录] ──→ TargetPath (属性)
    │
    └─→ [开始迁移] ──→ StartMigrationCommand (命令)
                           │
                           ▼
                    创建 MigrationConfig
                           │
                           ▼
                    创建 MigrationService
                           │
                           ▼
                    ExecuteMigrationAsync()
                           │
            ┌──────────────┼──────────────┐
            │              │              │
            ▼              ▼              ▼
      Progress<        Progress<    CancellationToken
      Migration        string>
      Progress>
            │              │              │
            │              │              │
            ▼              ▼              │
    更新 UI 进度条    添加日志消息      │
    ProgressPercent   LogMessages        │
    ProgressMessage                      │
            │                             │
            └─────────────┬───────────────┘
                          │
                          ▼
                    MigrationResult
                          │
                ┌─────────┴─────────┐
                ▼                   ▼
            Success             Error
                │                   │
                ▼                   ▼
          显示成功结果         显示错误+回滚
```

---

## 类图（核心类关系）

```
┌─────────────────────────┐
│   MigrationConfig       │
│─────────────────────────│
│ + SourcePath            │
│ + TargetPath            │
│ + LargeFileThresholdMB  │
│ + RobocopyThreads       │
└───────────┬─────────────┘
            │ 配置
            ▼
┌─────────────────────────┐
│   MigrationService      │
│─────────────────────────│
│ - _config               │
│ - _backupPath           │
│─────────────────────────│
│ + ExecuteMigrationAsync()│
│ - ValidatePathsAsync()  │
│ - ScanSourceDirectory() │
│ - CopyFilesAsync()      │
│ - CreateSymbolicLink()  │
│ - VerifySymbolicLink()  │
│ - CleanupBackupAsync()  │
│ - RollbackAsync()       │
└───────┬─────────────────┘
        │ 使用
        │
        ├──────────────────────┐
        │                      │
        ▼                      ▼
┌─────────────────┐   ┌─────────────────┐
│ PathValidator   │   │ FileStatsService│
│─────────────────│   │─────────────────│
│ + Validate...() │   │ + ScanDirectory()│
│ + IsAdmin()     │   │ + GetDirSize()  │
│ + CheckSpace()  │   │ + FormatBytes() │
└─────────────────┘   └─────────────────┘
        │
        ▼
┌─────────────────────┐
│ SymbolicLinkHelper  │
│─────────────────────│
│ + CreateDirSymlink()│
│ + IsSymbolicLink()  │
└─────────────────────┘
```

---

## 组件交互序列图（迁移执行）

```
用户        ViewModel       MigrationService    PathValidator    FileStatsService    SymbolicLinkHelper
 │              │                   │                  │                 │                    │
 ├─点击"开始迁移"─→│                   │                  │                 │                    │
 │              ├─ExecuteAsync()───→│                  │                 │                    │
 │              │                   ├─ValidatePaths──→│                 │                    │
 │              │                   │←─────OK──────────┤                 │                    │
 │              │                   │                  │                 │                    │
 │              │                   ├─ScanDirectory────┼────────────────→│                    │
 │              │                   │←────Stats────────┼─────────────────┤                    │
 │              │                   │                  │                 │                    │
 │              │                   ├─CopyFiles()      │                 │                    │
 │              │                   │  (robocopy)      │                 │                    │
 │              │←────Progress──────┤                  │                 │                    │
 │←─更新进度条───┤                   │                  │                 │                    │
 │              │                   │                  │                 │                    │
 │              │                   ├─CreateSymlink────┼─────────────────┼───────────────────→│
 │              │                   │←─────OK──────────┼─────────────────┼────────────────────┤
 │              │                   │                  │                 │                    │
 │              │                   ├─VerifySymlink────┼─────────────────┼───────────────────→│
 │              │                   │←─────OK──────────┼─────────────────┼────────────────────┤
 │              │                   │                  │                 │                    │
 │              │                   ├─CleanupBackup()  │                 │                    │
 │              │                   │                  │                 │                    │
 │              │←────Result────────┤                  │                 │                    │
 │←─显示结果─────┤                   │                  │                 │                    │
 │              │                   │                  │                 │                    │
```

---

## 技术栈层次图

```
┌────────────────────────────────────────────────────┐
│              开发工具 (Development Tools)           │
│  • Visual Studio 2022                              │
│  • .NET 8 SDK                                      │
│  • Windows App SDK                                 │
└────────────────────────────────────────────────────┘
                        │
                        ▼
┌────────────────────────────────────────────────────┐
│           UI 框架 (UI Framework)                    │
│  • WinUI 3 (Windows App SDK 1.5)                   │
│  • XAML                                             │
│  • Fluent Design System                            │
└────────────────────────────────────────────────────┘
                        │
                        ▼
┌────────────────────────────────────────────────────┐
│        MVVM 框架 (MVVM Framework)                   │
│  • CommunityToolkit.Mvvm 8.2                       │
│  • INotifyPropertyChanged                          │
│  • ICommand / RelayCommand                         │
│  • ObservableCollection                            │
└────────────────────────────────────────────────────┘
                        │
                        ▼
┌────────────────────────────────────────────────────┐
│       运行时 (Runtime)                              │
│  • .NET 8.0                                        │
│  • Target: net8.0-windows10.0.19041.0             │
│  • CLR, BCL                                        │
└────────────────────────────────────────────────────┘
                        │
                        ▼
┌────────────────────────────────────────────────────┐
│    Windows API & 系统工具 (Windows API & Tools)     │
│  • P/Invoke (CreateSymbolicLink)                   │
│  • robocopy.exe                                    │
│  • cmd.exe (mklink)                                │
│  • File System API                                 │
└────────────────────────────────────────────────────┘
                        │
                        ▼
┌────────────────────────────────────────────────────┐
│           操作系统 (Operating System)               │
│  • Windows 10 (Build 19041+)                       │
│  • Windows 11                                       │
│  • NTFS File System                                │
└────────────────────────────────────────────────────┘
```

---

## 部署架构

```
开发环境 (Development)
    │
    ├─ Visual Studio 2022
    ├─ .NET 8 SDK
    └─ Windows App SDK
    │
    ▼
源代码 (Source Code)
    │
    ├─ MigrationCore.csproj
    └─ MoveWithSymlinkGUI.csproj
    │
    ▼
构建 (Build)
    │
    ├─ dotnet restore
    ├─ dotnet build
    └─ MSBuild
    │
    ▼
输出 (Output)
    │
    ├─ bin/x64/Release/
    │   ├─ MoveWithSymlinkGUI.exe
    │   ├─ MigrationCore.dll
    │   └─ Dependencies/
    │
    ▼
分发 (Distribution)
    │
    ├─ Framework-Dependent
    │   └─ 需要 .NET 8 Runtime
    │
    └─ Self-Contained
        └─ 包含完整运行时
```

---

## 安全架构

```
┌─────────────────────────────────────────────────────┐
│                    用户操作                          │
└─────────────────────┬───────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────┐
│               输入验证层 (Input Validation)          │
│  • PathValidator.ValidateSourcePath()               │
│  • PathValidator.ValidateTargetPath()               │
│  • PathValidator.ValidatePathRelation()             │
└─────────────────────┬───────────────────────────────┘
                      │
        ┌─────────────┼─────────────┐
        │             │             │
        ▼             ▼             ▼
┌────────────┐ ┌───────────┐ ┌────────────┐
│ 阻止系统   │ │ 警告云盘  │ │ 检查权限   │
│ 目录       │ │ 目录      │ │ 和空间     │
└──────┬─────┘ └─────┬─────┘ └──────┬─────┘
       │             │              │
       └─────────────┼──────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────┐
│              执行层 (Execution Layer)                │
│  • 备份原目录 (原子操作)                              │
│  • 复制文件 (可中断)                                  │
│  • 创建链接 (可回滚)                                  │
└─────────────────────┬───────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────┐
│             验证层 (Verification Layer)              │
│  • 验证复制完整性 (大小比对)                           │
│  • 验证符号链接 (重解析点检查)                         │
│  • 验证可访问性 (目录存在性)                           │
└─────────────────────┬───────────────────────────────┘
                      │
                      ▼
          ┌───────────┴───────────┐
          │ 成功                  │ 失败
          ▼                       ▼
┌──────────────────┐    ┌─────────────────────┐
│ 清理备份目录      │    │ 自动回滚            │
│ 完成迁移         │    │ • 删除符号链接      │
└──────────────────┘    │ • 还原备份目录      │
                        └─────────────────────┘
```

---

**提示**: 此架构图可作为理解项目结构和设计的参考 📐

