# 版本管理说明

## 概述

本项目实现了自动版本号管理功能。每次打包时，小版本号（patch）会自动递增，生成的 exe 文件名会包含版本号。

## 版本号格式

版本号采用 **语义化版本号（Semantic Versioning）** 格式：`major.minor.patch`

- **major**: 主版本号（重大更新，可能包含不兼容的 API 变更）
- **minor**: 次版本号（功能性更新，向后兼容）
- **patch**: 补丁版本号（Bug 修复，向后兼容）

**当前版本**: `1.0.0`

## 自动版本管理

### 版本配置文件

版本信息存储在 `version.json` 文件中：

```json
{
  "major": 1,
  "minor": 0,
  "patch": 0,
  "description": "版本号管理文件 - 每次打包时自动递增 patch 版本号"
}
```

### 打包脚本行为

当运行 `publish.ps1` 或 `publish-advanced.ps1` 时，脚本会：

1. **读取当前版本号**
   - 从 `version.json` 读取当前版本

2. **递增版本号**
   - 自动将 `patch` 版本号加 1
   - 例如：`1.0.0` → `1.0.1` → `1.0.2`

3. **更新项目文件**
   - 自动更新 `MoveWithSymlinkWPF.csproj` 中的版本信息
   - 更新三个字段：`<Version>`、`<AssemblyVersion>`、`<FileVersion>`

4. **编译打包**
   - 使用新版本号编译项目

5. **重命名输出文件**
   - 将生成的 `目录迁移工具.exe` 重命名为 `目录迁移工具-v1.0.1.exe`
   - 文件名格式：`目录迁移工具-v{major}.{minor}.{patch}.exe`

## 使用示例

### 标准打包

```powershell
# 运行标准打包脚本
.\publish.ps1

# 输出示例：
# Current version: 1.0.0
# New version: 1.0.1
# 生成文件: 目录迁移工具-v1.0.1.exe
```

### 高级打包

```powershell
# 打包标准版本
.\publish-advanced.ps1 standard

# 打包快速启动版本
.\publish-advanced.ps1 fast

# 打包所有版本
.\publish-advanced.ps1 all
```

## 手动修改版本号

如果需要手动调整主版本号或次版本号：

### 方法 1：编辑 version.json

```json
{
  "major": 2,      // 修改主版本号
  "minor": 0,      // 修改次版本号
  "patch": 0,      // 重置补丁号
  "description": "版本号管理文件 - 每次打包时自动递增 patch 版本号"
}
```

### 方法 2：使用 PowerShell 命令

```powershell
# 升级到 2.0.0（主版本升级）
$version = Get-Content version.json | ConvertFrom-Json
$version.major = 2
$version.minor = 0
$version.patch = 0
$version | ConvertTo-Json | Set-Content version.json

# 升级到 1.1.0（次版本升级）
$version = Get-Content version.json | ConvertFrom-Json
$version.minor = 1
$version.patch = 0
$version | ConvertTo-Json | Set-Content version.json
```

修改后，再次运行打包脚本，版本号会从新的基础上开始递增。

## 版本历史追踪

建议在 Git 提交信息中记录版本号变更：

```bash
# 提交版本更新
git add version.json MoveWithSymlinkWPF/MoveWithSymlinkWPF.csproj
git commit -m "chore: bump version to 1.0.1"

# 打标签
git tag v1.0.1
git push origin v1.0.1
```

## 输出文件示例

打包后的文件结构：

```
MoveWithSymlinkWPF\bin\publish\
├── win-x64\
│   └── 目录迁移工具-v1.0.1.exe (标准版)
└── win-x64-fast\
    └── 目录迁移工具-v1.0.2.exe (快速启动版)
```

## 注意事项

1. **每次打包都会递增版本号**
   - 无论打包是否成功，版本号都会递增
   - 如果需要重新打包同一版本，需要手动还原 `version.json`

2. **版本号同步**
   - 版本号会自动同步到 `.csproj` 文件
   - 编译后的 exe 文件属性中会显示正确的版本信息

3. **文件名中的版本号**
   - 文件名中包含完整的版本号，便于版本管理和分发
   - 示例：`目录迁移工具-v1.0.1.exe`

4. **Git 版本控制**
   - `version.json` 应该提交到 Git
   - 建议在发布时打 Git 标签
   - `.csproj` 文件的版本更新也应该提交

## 最佳实践

1. **语义化版本规范**
   - **Bug 修复**: 递增 patch（自动）
   - **新功能（向后兼容）**: 手动递增 minor，重置 patch 为 0
   - **重大更新（不兼容）**: 手动递增 major，重置 minor 和 patch 为 0

2. **版本发布流程**
   ```bash
   # 1. 确认当前版本
   cat version.json
   
   # 2. 运行打包脚本
   .\publish.ps1
   
   # 3. 测试生成的 exe
   
   # 4. 提交版本更新
   git add version.json MoveWithSymlinkWPF/MoveWithSymlinkWPF.csproj
   git commit -m "chore: release v1.0.1"
   
   # 5. 打标签
   git tag v1.0.1
   git push origin master --tags
   ```

3. **回滚版本**
   如果打包失败需要回滚：
   ```powershell
   # 手动减少 patch 号
   $version = Get-Content version.json | ConvertFrom-Json
   $version.patch--
   $version | ConvertTo-Json | Set-Content version.json
   ```

## 查看文件版本信息

在 Windows 中右键点击 exe 文件，选择"属性" → "详细信息"，可以看到：
- 产品名称: 目录迁移工具
- 产品版本: 1.0.1
- 文件版本: 1.0.1.0
- 公司: 诏无言
- 版权: Copyright © 2025 诏无言

---

**作者**: 诏无言  
**更新日期**: 2025年10月22日

