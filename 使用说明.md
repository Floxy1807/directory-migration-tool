# 使用说明 - Directory Migration Tool

## 快速开始

### 1. PowerShell CLI 版本（推荐快速使用）

直接运行现有的 PowerShell 脚本，无需编译：

```powershell
# 以管理员身份运行 PowerShell
.\MoveWithSymlink.ps1 -Source "C:\要迁移的目录" -Target "D:\目标位置"
```

**示例**:
```powershell
.\MoveWithSymlink.ps1 -Source "C:\Users\YourName\Pictures\testMove" -Target "D:\Data\testMove"
```

**可选参数**:
```powershell
-LargeFileThresholdMB 1024    # 大文件阈值，默认 1024MB (1GB)
-RobocopyThreads 8            # 复制线程数，默认 8
-SampleMilliseconds 1000      # 进度刷新间隔，默认 1000ms
```

### 2. WinUI 3 GUI 版本（新增功能）

#### 构建应用

**方式 A: 使用构建脚本（推荐）**
```powershell
# 以管理员身份运行 PowerShell
.\build.ps1
```

**方式 B: 手动构建**
```powershell
# 1. 还原依赖
dotnet restore MoveWithSymlink.sln

# 2. 构建项目
dotnet build MoveWithSymlink.sln -c Release

# 3. 或仅构建 GUI
cd MoveWithSymlinkGUI
dotnet build -c Release
```

#### 运行应用

```powershell
# 方式 1: 使用 dotnet run
cd MoveWithSymlinkGUI
dotnet run -c Release

# 方式 2: 直接运行可执行文件
cd MoveWithSymlinkGUI\bin\x64\Release\net8.0-windows10.0.19041.0
.\MoveWithSymlinkGUI.exe
```

**注意**: GUI 应用需要管理员权限，请右键选择"以管理员身份运行"

## GUI 使用流程

### 步骤 1: 选择路径 ✨

1. **源目录**: 点击"浏览..."按钮选择要迁移的目录
   - 例如: `C:\Users\YourName\Pictures`
   - 或手动输入路径

2. **目标目录**: 点击"浏览..."按钮选择迁移到的位置
   - 例如: `D:\Data\Pictures`
   - 或手动输入路径

3. **高级选项**（可选）:
   - **大文件阈值**: 设置多大的文件算作"大文件"（用于统计）
   - **复制线程数**: robocopy 并行线程数，越大复制越快（但占用更多资源）

4. 点击 **下一步** 按钮

系统会自动验证：
- ✅ 源目录是否存在
- ✅ 是否为系统关键目录（会阻止）
- ✅ 目标路径是否合法
- ✅ 源和目标的关系（不能相同、不能互为子目录）
- ⚠️ 是否为云盘同步目录（会警告）
- ⚠️ 是否有管理员权限

### 步骤 2: 扫描分析 📊

1. 查看扫描提示信息
2. 点击 **开始扫描** 按钮

系统会显示：
- 📁 总文件数
- 💾 总大小（格式化显示，如 15.3 GB）
- 📦 大文件数量（超过阈值的文件个数）
- 💿 目标磁盘可用空间
- ⚠️ 所需空间（含 10% 余量）

如果空间不足，系统会自动提示并阻止继续。

3. 确认无误后，点击 **下一步**

### 步骤 3: 执行迁移 🚀

1. 查看迁移信息摘要
2. 点击 **开始迁移** 按钮

迁移过程会显示：
- 📈 实时进度条（百分比）
- ⏱️ 当前阶段（共 6 个阶段）
- 💨 复制速度（如 125.5 MB/s）
- ⏰ 预计剩余时间
- 📝 详细日志输出（实时滚动）

**6 个迁移阶段**:
1. **路径解析与验证** - 最终检查
2. **扫描源目录** - 确认统计信息
3. **复制文件** - 使用 robocopy 镜像复制
4. **创建符号链接** - 备份并创建链接
5. **健康检查** - 验证链接有效性
6. **清理备份** - 删除备份目录

**可选操作**:
- 点击 **取消** 按钮可中止迁移（会自动回滚）

### 步骤 4: 完成 ✅

迁移完成后会显示：
- ✅ 成功图标（绿色勾）
- ❌ 失败图标（红色叉）

**成功时显示**:
- 源路径（现为符号链接）
- 目标路径（实际存储位置）
- 统计信息汇总

**失败时显示**:
- 错误信息
- 是否已回滚

点击 **完成** 按钮可重置应用，进行新的迁移。

## 安全机制 🛡️

### 自动阻止迁移的目录

以下系统关键目录会被自动阻止，无法迁移：
- `C:\Windows`
- `C:\Program Files`
- `C:\Program Files (x86)`
- `C:\ProgramData\Microsoft`
- `C:\System Volume Information`

### 警告提示的目录

以下目录会显示警告（但允许继续）：
- OneDrive 同步目录
- Dropbox 同步目录
- Google Drive 同步目录
- iCloud Drive 同步目录

### 自动回滚机制

任何步骤失败都会自动回滚：
1. 删除已创建的符号链接（如果有）
2. 将备份目录还原到原位置
3. 保证原目录可用

## 常见问题 ❓

### Q1: 需要管理员权限吗？

**A**: 
- 推荐以管理员身份运行
- 如果启用了"开发者模式"，可以不需要管理员权限

**启用开发者模式**:
1. 打开 **设置** > **隐私和安全性** > **开发者选项**
2. 开启 **开发人员模式**

### Q2: 迁移后原路径还能用吗？

**A**: 可以！原路径会变成一个符号链接，指向新的目标位置。对应用程序来说完全透明，就像文件还在原位置一样。

### Q3: 可以跨盘迁移吗？

**A**: 完全可以！符号链接支持跨磁盘，甚至支持网络路径。

### Q4: 迁移失败了怎么办？

**A**: 不用担心！系统会自动回滚，恢复到迁移前的状态。原目录保持可用。

### Q5: 复制需要多久？

**A**: 取决于文件大小和磁盘速度。GUI 会显示实时进度和预计剩余时间。

示例参考：
- 50GB 数据，SSD 到 SSD：约 5-10 分钟
- 50GB 数据，HDD 到 HDD：约 15-30 分钟

### Q6: 可以迁移正在使用的目录吗？

**A**: 不建议！可能导致：
- 文件被占用，复制失败
- 应用程序读写错误

建议关闭相关应用后再迁移。

### Q7: 迁移后可以删除目标目录吗？

**A**: 不能！目标目录是实际存储位置，删除后符号链接会失效，原路径无法访问。

### Q8: 如何撤销迁移？

手动撤销步骤：
1. 删除源路径的符号链接
2. 将目标目录的内容移回源路径

或者使用反向迁移（从目标迁移回源）。

### Q9: GUI 启动失败怎么办？

可能原因：
1. **缺少 .NET 8 运行时**
   - 下载安装: https://dotnet.microsoft.com/download/dotnet/8.0

2. **缺少 Windows App SDK**
   - 通常随 .NET 8 一起安装
   - 或运行: `winget install Microsoft.WindowsAppRuntime.1.5`

3. **Windows 版本过低**
   - 需要 Windows 10 1809 (Build 17763) 或更高
   - 推荐 Windows 10 21H2 或 Windows 11

### Q10: PowerShell 版本和 GUI 版本有什么区别？

| 特性 | PowerShell CLI | WinUI 3 GUI |
|------|----------------|-------------|
| 使用难度 | 需要命令行参数 | 向导式界面，更友好 |
| 安装要求 | 无需安装 | 需要 .NET 8 |
| 进度显示 | 命令行进度条 | 图形化进度条 + 日志 |
| 日志输出 | 控制台输出 | 实时日志窗口 |
| 错误处理 | 命令行提示 | 图形化错误提示 |
| 适用场景 | 自动化脚本、批处理 | 日常交互使用 |

**建议**:
- 首次使用 → GUI 版本（更直观）
- 批量/自动化 → PowerShell 版本

## 技术支持 🔧

### 查看日志

**PowerShell 版本**:
- 所有输出都在控制台显示
- 可以重定向到文件: `.\MoveWithSymlink.ps1 ... | Tee-Object -FilePath log.txt`

**GUI 版本**:
- 实时日志窗口显示所有操作
- 可以手动复制保存

### 报告问题

如果遇到问题，请提供：
1. Windows 版本（Win+R → `winver`）
2. .NET 版本（`dotnet --version`）
3. 错误消息截图或文本
4. 源/目标路径信息（敏感信息可脱敏）
5. 日志输出

## 最佳实践 💡

### ✅ 推荐做法

1. **迁移前备份重要数据**
2. **关闭使用该目录的应用**
3. **确保目标磁盘空间充足（至少 10% 余量）**
4. **使用 NTFS 文件系统**
5. **迁移大目录时，使用较大的线程数（如 16）**
6. **迁移完成后测试应用功能**

### ❌ 避免做法

1. ❌ 不要迁移系统目录
2. ❌ 不要迁移正在使用的应用目录
3. ❌ 不要迁移到网络驱动器（性能较差）
4. ❌ 不要在迁移过程中关机或重启
5. ❌ 不要手动删除备份目录（`.bak_*`）
6. ❌ 不要同时迁移多个目录到同一目标

## 适用场景示例 🎯

### 1. 游戏目录迁移
```
源: C:\Program Files\Steam\steamapps\common\GameName
目标: D:\Games\GameName
```
迁移后 Steam 仍能正常识别游戏。

### 2. 用户文档迁移
```
源: C:\Users\YourName\Documents
目标: D:\MyDocuments
```
所有引用该路径的应用不受影响。

### 3. 开发环境缓存
```
源: C:\Users\YourName\.gradle
目标: D:\DevCache\.gradle
```
Gradle 构建仍能正常工作。

### 4. 虚拟机磁盘迁移
```
源: C:\Users\YourName\VirtualBox VMs
目标: E:\VMs
```
VirtualBox 仍能找到虚拟机。

---

**祝您使用愉快！如有问题欢迎反馈 😊**

