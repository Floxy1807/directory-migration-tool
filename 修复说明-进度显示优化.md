# 进度显示优化说明

## 修改日期
2025-10-22

## 问题描述
之前的进度显示逻辑存在问题：复制完成后就显示100%，但实际上还有第4、5、6步需要完成。这导致用户看到100%后，还需要等待后续步骤，体验不佳。

## 解决方案
重新设计进度分配，让6个步骤合理地映射到0-100%的进度：

### 进度分配方案
- **第1步（路径解析与验证）**：0-5%
- **第2步（扫描源目录）**：5-10%
- **第3步（复制文件）**：10-90%（占80%，因为这是最耗时的步骤）
- **第4步（创建符号链接）**：90-93%
- **第5步（健康检查）**：93-96%
- **第6步（清理备份）**：96-100%

### 核心逻辑修改

#### 复制进度映射（第3步）
复制阶段的实际进度（0-100%）映射到总进度的10-90%：

```csharp
// C# 版本
double copyPercent = stats.TotalBytes > 0 ? Math.Min(100, (copiedBytes * 100.0) / stats.TotalBytes) : 0;
double percent = 10 + (copyPercent * 0.8);  // 映射到10-90%
```

```powershell
# PowerShell 版本
$copyPercent = if ($ExpectedBytes -gt 0) { [math]::Min(100, [math]::Floor(($copied * 100.0) / $ExpectedBytes)) } else { 0 }
$percent = 10 + ($copyPercent * 0.8)  # 映射到10-90%
```

## 修改文件

### 1. MigrationCore/Services/MigrationService.cs
- ✅ 修改 `CopyFilesAsync` 方法：
  - 初始进度从0%改为10%
  - 复制过程中的进度映射到10-90%
  - 复制完成时显示90%（而非100%）
  
- ✅ 修改 `ReportPhase` 方法：
  - 使用 switch 表达式分配各阶段的起始进度
  - 第1步=0%, 第2步=5%, 第4步=90%, 第5步=93%, 第6步=96%
  
- ✅ 修改 `ExecuteMigrationAsync` 方法：
  - 在所有步骤完成后报告最终100%进度

### 2. MoveWithSymlink.ps1
- ✅ 修改 `Start-RobocopyWithProgress` 函数：
  - 复制进度映射到10-90%
  - 复制完成时显示90%（而非100%）
  - Activity名称包含步骤信息 `[3/6]`
  
- ✅ 添加各步骤的进度显示：
  - 第1步：Write-Progress 显示0%
  - 第2步：Write-Progress 显示5%
  - 第4步：Write-Progress 显示90-93%
  - 第5步：Write-Progress 显示93-96%
  - 第6步：Write-Progress 显示96-100%，完成时标记为 `-Completed`

## 用户体验改进
1. ✅ **准确的进度显示**：进度条真实反映整体完成度
2. ✅ **避免假性完成**：不会在90%的工作完成后就显示100%
3. ✅ **合理的时间预期**：用户看到进度就能估算剩余时间
4. ✅ **清晰的阶段提示**：每个步骤都有对应的进度范围

## 测试建议
1. 运行WPF应用，观察进度条是否平滑增长到90%后继续增长到100%
2. 运行PowerShell脚本，检查Write-Progress显示是否正确
3. 验证复制大文件时，进度在10-90%范围内正常更新
4. 确认最后三步执行时进度正确显示90-100%

## 技术细节

### 为什么复制占80%？
- 复制文件是最耗时的操作，通常占总时间的90%以上
- 给复制分配80%的进度空间更符合实际时间分布
- 剩余20%留给其他5个步骤，保证后续步骤也有可见的进度变化

### 进度计算精度
- PowerShell使用 `[math]::Floor` 确保显示整数百分比
- C#使用 `double` 保持精度，UI层决定显示格式
- 两个版本逻辑保持一致

## 相关文件
- `MigrationCore/Services/MigrationService.cs` - C#核心服务
- `MoveWithSymlink.ps1` - PowerShell脚本版本
- `MoveWithSymlinkWPF/ViewModels/MainViewModel.cs` - WPF视图模型（无需修改，只是接收进度更新）

